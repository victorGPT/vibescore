# PR #89 复盘（Codex Review Churn）

## 范围
- PR: https://github.com/victorGPT/vibeusage/pull/89
- 目的：解释多轮 @codex review 的根因，并给出改进动作

## 现象（Phenomenon）
- 多次触发 Codex 评审与修复：
  - 解析阶段：项目级统计因 repo root 推断失败而失效
  - 上传阶段：combined batch 超过服务端上限导致潜在 413
  - 清理阶段：blocked 状态与 purge 触发存在边界缺口

## 本质（Essence）
- 缺口集中在“边界条件”和“系统约束未被编码”：
  - rollout 文件路径并不在 repo 内，但解析逻辑默认从文件路径向上找 `.git`
  - 上传端 `batchSize` 与服务端 `MAX_BUCKETS` 的硬约束未在客户端体现
  - remote 缺失/非 GitHub 时，blocked 记录需要回溯到历史项目（repo_root_hash）

## 根因归因（Stage Attribution）
- **Implementation**
  - 未覆盖“rollout 文件路径不在 repo 内”的真实运行路径
  - uploader 组合队列后未考虑服务端最大桶数硬限制
- **Testing**
  - 缺少回归用例覆盖：
    - turn_context.cwd → projectKey
    - remote 缺失但 repo_root_hash 可回溯 → blocked + purge_pending
    - combined batch size cap
- **Design / Constraints**
  - 服务端 `MAX_BUCKETS` 约束未明确反馈到客户端实现（约束传播不足）

## 证据链（Evidence）
- Codex 反馈 → 修复 → 新增回归：
  1) repo root 推断错误 → 使用 `turn_context.cwd` 解析 → `test/rollout-parser.test.js` 新用例
  2) blocked 未记录 → 基于 `repo_root_hash` 关联历史项目 → 新用例
  3) combined batch 超限 → uploader 端 cap combined → `test/uploader.test.js` 新用例

## 已完成的修复与验证
- 解析层：`turn_context.cwd` 恢复 project context
- 清理层：blocked 状态可在 projectKey 缺失时通过 repo_root_hash 回溯
- 上传层：combined batch 上限遵循服务端 MAX_BUCKETS
- 验证：
  - `node --test test/rollout-parser.test.js`
  - `node --test test/uploader.test.js`

## 改进动作（Preventive Actions）
1) **约束同步**：客户端实现需显式编码服务端硬上限（如 MAX_BUCKETS）
2) **边界用例固定化**：新增回归覆盖真实运行路径（sessions 目录、remote 缺失等）
3) **评审前清单**：在 PR 描述中明确“输入来源与路径” + “服务端约束”

## 下一步
- 无追加动作。若后续出现类似 churn，优先检查“路径假设”与“服务端约束同步”。
