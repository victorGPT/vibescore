# Frontend Foundation Refactor Design (2026-01-23)

## 背景与目标
当前 Dashboard 前端（`dashboard/`）存在 UI 组件层级与状态组织混乱的问题，维护成本高。你要求：**最终视觉效果与现状一致**（像素级一致），但允许我在代码底层进行**彻底重构**，以提升可维护性与结构清晰度（优先级 A）。

**核心目标**
- 视觉输出保持一致（布局、颜色、字体、间距）。
- 组件层级与数据流简化、边界清晰。
- 删除无明确职责的“胶水层”，降低耦合。
- 不引入长期兼容路径；必要时仅允许短期过渡并明确清理。

## 关键决策
- **一致性标准**：采用“视觉像素级一致”，交互细节允许微调（hover/焦点等）。
- **合并策略**：UI 组件深度重构作为“前端基础重构”的子阶段统一推进，避免重复拆改。

## 范围 / 非目标
**范围（IN）**
- `dashboard/src/ui/matrix-a/**` 组件结构重组。
- `dashboard/src/pages/**` 页面组合方式调整。
- `dashboard/src/hooks/**` 与 `dashboard/src/lib/**` 的职责重整（仅限前端侧）。

**非目标（OUT）**
- 后端 API 或协议变更。
- 视觉/交互风格更新。
- 新功能开发。

## 现状快照（简述）
- UI 组件在 `ui/matrix-a` 中高度碎片化，部分组件承担业务逻辑与视图混合职责。
- 数据来源主要通过 `hooks/` + `lib/`，但缺少统一的领域模型与数据整形层。
- 页面层在组装 UI 时缺少清晰的“容器/展示”分界。

## 方案概览（保持视觉一致的彻底重构）
**原则**
- 视觉冻结：以现有 UI 作为“视觉基线”，重构过程中对比验证。
- 单一真源：建立明确的数据整形与视图模型边界。
- 组件职责单一化：容器组件负责数据与状态，展示组件只负责渲染。

**高层结构**
```
/pages         // 页面编排（容器层）
/ui            // 展示组件（无业务逻辑）
/hooks         // 数据获取与状态拼装
/lib           // API / 数据整形 / 纯工具
```

## 组件与模块设计
1) **容器组件（页面层）**
- 统一在 `pages/` 处理数据请求、聚合与错误分支。
- 将“状态 + 数据”注入 `ui/` 中的展示组件。

2) **展示组件（ui 层）**
- 只接收 props，禁止直接调用 API 或 hooks。
- 重构时保持 DOM 结构和 CSS class 语义尽量稳定，以保证视觉一致。

3) **数据层**
- `hooks/` 负责获取数据与局部状态拼装。
- `lib/` 负责 API 调用与数据整形（例如 usage/model breakdown 等）。

## 数据流与错误处理
- 数据流方向：`pages -> hooks/lib -> ui`。
- 错误处理集中在页面层（ErrorBoundary/空态/降级 UI）。
- hooks 中只返回结构化数据与加载状态，不直接决定 UI。

## 验证与测试策略
- **视觉一致性验证**：采集现有页面的基线截图（或关键 DOM 结构快照），重构后对比。
- **功能回归**：复用现有 hooks/数据请求路径，确保无接口变更。
- **手动检查清单**：核心页面（Dashboard/Landing）进行人工核对。

## 迁移策略
- 以“单次切换”为主：逐模块完成后切换至新结构，避免长期双轨。
- 若必须临时双轨，需明确时间边界并在 plan 中列出移除任务。

## Canvas 影响
- 这是 Dashboard 模块内部重构，不改变系统边界。
- 在 `architecture.canvas` 中新增 “UI Foundation (Proposed)” 节点，用于标注重构后的组件基础层。

## 风险与缓解
- **视觉偏差**：通过基线对比与关键页面复核降低风险。
- **逻辑遗漏**：集中在页面层做状态与错误处理，减少隐式逻辑散落。

## 开放问题
- 视觉基线采用“截图对比”还是“关键 DOM 结构快照”？
- 是否允许轻微交互微调（hover/焦点）？目前按“允许”处理。
